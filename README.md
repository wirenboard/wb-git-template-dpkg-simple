# Шаблон для создания простого deb-пакета

Этот репозиторий предоставляет шаблон для создания простых deb-пакетов\
посредством сборки инструментом `dpkg-buildpackage`. Данный пример пакета\
предназначен для установки на контроллеры Wiren Board.

Шаблон включает примеры виртуальных устройств, написанных на JavaScript,\
и необходимые скрипты для сборки пакета.

В процессе создании deb-пакета используются два различных термина:

- **Сборка** - это предварительная подготовка файлов проекта перед упаковкой\
  в пакет, например перемещение файлов, кросс-компиляция и т.д.\
  Этим шагом в `dpkg-buildpackage` занимается `debhelper`.
- **Упаковка** - это процесс непосредственного создания deb-пакета из уже\
  готовых файлов. Этим шагом в `dpkg-buildpackage` занимается `dpkg-deb`.

Важно, что упаковка и сборка - это разные процессы. Упаковка не включает\
в себя сборку, так же как сборка не включает в себя упаковку.

## Содержание

- [Шаблон для создания простого deb-пакета](#шаблон-для-создания-простого-deb-пакета)
  - [Содержание](#содержание)
  - [Структура проекта](#структура-проекта)
  - [Настройка пакета](#настройка-пакета)
  - [Сборка пакета](#сборка-пакета)
    - [Установка необходимых инструментов](#установка-необходимых-инструментов)
    - [Сборка](#сборка)
  - [Установка и удаление пакета](#установка-и-удаление-пакета)
    - [Установка](#установка)
    - [Удаление](#удаление)
  - [Дополнительная информация](#дополнительная-информация)
    - [Использование Makefile](#использование-makefile)
    - [Файл debian/install](#файл-debianinstall)
    - [Скрипт postinst](#скрипт-postinst)
  - [Лицензия](#лицензия)

## Структура проекта

- `src/` — исходные файлы JavaScript:
  - `vd-pump-1.js` — пример виртуального насоса
  - `vd-wall-switch-1.js` — пример виртуального настенного выключателя
  - `vd-water-meter-1.js` — пример виртуального счетчика воды
- `debian/` — файлы, необходимые для сборки пакета:
  - `changelog` — лог изменений
  - `compat` — версия совместимости debhelper
  - `control` — метаданные пакета
  - `rules` — скрипт сборки
  - `dirs` — список директорий для создания
  - `postinst` — скрипт, выполняемый после установки
- `Makefile` — скрипт для установки файлов во время сборки
- `LICENSE` — лицензия на использование программного обеспечения
- `.gitignore` — файлы и директории, игнорируемые Git
- `Jenkinsfile` — конфигурация для CI/CD
- `README.md` — документация (настоящее руководство)

## Настройка пакета

Перед сборкой пакета необходимо внести изменения в некоторые файлы:

1. **Настройте исходные файлы**:
   - Добавьте или измените файлы в директории `src/` в соответствии с вашими\
     потребностями

2. **Измените название пакета**:

   - В `debian/control` замените `wb-packetname` на желаемое имя\
     пакета в полях `Source` и `Package`

3. **Обновите информацию в changelog**:

   - Отредактируйте файл `debian/changelog`, добавив информацию о\
     вашей версии пакета. Или создайте новый с помошью инструмента `dch`

4. **Отредактируйте makefile**:
   - Измените содержимое `Makefile` в соответствии с вашими потребностями

## Сборка пакета

### Установка необходимых инструментов

Убедитесь, что у вас установлены следующие пакеты:
- git - для клонирования репозитория c GitHub
- dpkg-buildpackage в пакете dpkg-dev - нужен для сборки в deb-пакет
- debhelper - его использует dpkg-buildpackage
- make - его запустит debhelper для сборки файлов

```terminal
$ sudo apt update && \
  sudo apt install git && \
  sudo apt install dpkg-dev && \
  sudo apt install debhelper && \
  sudo apt install make
```

### Сборка

1. Клонируйте репозиторий:

   ```terminal
   $ git clone https://github.com/wirenboard/wb-git-template-dpkg-simple.git && \
   cd wb-git-template-dpkg-simple
   ```

В процессе разработки удобно клонировать свою ветку и сразу провести установку

  ```terminal
  $ GIT_BRANCH_NAME="feature/add-template-files-first-iteration"
  $ git clone -b "${GIT_BRANCH_NAME}" --single-branch "https://github.com/wirenboard/wb-git-template-dpkg-simple.git" && \
    cd wb-git-template-dpkg-simple
  ```

2. Соберите пакет:

   ```terminal
   $ dpkg-buildpackage -rfakeroot -us -uc
   ```

   После успешной сборки в родительской директории появится файл `*.deb`

3. Отчистка сгенерированных файлов:

  При сборке генерируется много файлов, которые можно удалить:

   ```terminal
   $ dpkg-buildpackage -rfakeroot -Tclean
   ```

## Установка и удаление пакета

### Установка

```terminal
$ sudo apt install -y ../wb-packetname_0.0.1_all.deb
```

После установки новые виртуальные устройства станут доступны на вашем\
контроллере Wiren Board.

### Удаление

```terminal
$ sudo apt remove wb-packetname
```

## Дополнительная информация

### Использование Makefile

Для простого копирования файлов можно использовать несколько вариантов,\
`Makefile` в данном шаблоне выбран по причине широких возможностей\
и приминимости в том числе в других задачах, например при кросскомпиляции.

В данном шаблоне `Makefile` используется для копирования файлов из `src/`\
в целевую директорию. Обратите внимание, что данный файл исполняется только\
во время сборки пакета, он не работает при установке на машине пользователя.\
Если нужно сделать что-то перед/после установки - нужно использовать\
скрипты `debian/postinst` и тд.

### Файл debian/install

Альтернативно, вместо использования `Makefile` вы можете использовать\
файл `debian/install` для указания файлов и директорий для установки:

```script
src/*.js usr/lib/wirenboard/virtual-devices/
```

### Скрипт postinst

Файл `debian/postinst` используется для выполнения действий после установки\
пакета. В данном шаблоне он перезапускает сервис `wb-rules`:

```bash
#!/bin/sh
set -e

deb-systemd-invoke restart wb-rules

#DEBHELPER#

exit 0
```

## Лицензия

Данный проект распространяется под лицензией The WB License (MIT-WB).\
Подробности доступны в файле [LICENSE](LICENSE).
